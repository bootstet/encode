(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{445:function(t,e,v){"use strict";v.r(e);var s=v(25),_=Object(s.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"前端工程化问答-pre-commit-钩子、bootstet-fe-lint-与-workspace-协议"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前端工程化问答-pre-commit-钩子、bootstet-fe-lint-与-workspace-协议"}},[t._v("#")]),t._v(" 前端工程化问答：pre-commit 钩子、bootstet-fe-lint 与 workspace 协议")]),t._v(" "),e("p",[t._v("本文记录本仓库在 pre-commit 钩子、前端代码扫描 CLI（bootstet-fe-lint）以及 monorepo 依赖管理（workspace 协议）方面的排查与优化结论，便于后续复用与维护。")]),t._v(" "),e("h2",{attrs:{id:"背景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[t._v("#")]),t._v(" 背景")]),t._v(" "),e("ul",[e("li",[t._v("项目使用 Husky 管理 Git 钩子，包含 pre-commit 与 commit-msg。")]),t._v(" "),e("li",[t._v("本地有自研 CLI：bootstet-fe-lint，含子命令：scan、commit-file-scan、commit-msg-scan。")]),t._v(" "),e("li",[t._v("monorepo 结构（packages/*），需要在根包依赖本地子包。")])]),t._v(" "),e("h2",{attrs:{id:"问题表现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题表现"}},[t._v("#")]),t._v(" 问题表现")]),t._v(" "),e("ul",[e("li",[t._v("早期 pre-commit 使用 "),e("code",[t._v("scan")]),t._v(" 子命令，出现“有错误也提示通过”的现象（未阻止提交）。")]),t._v(" "),e("li",[t._v("更换为 "),e("code",[t._v("commit-file-scan")]),t._v(" 后，曾出现钩子未运行或绕过检查；手动模拟时出现 126 错误（cannot execute binary file）。")]),t._v(" "),e("li",[t._v("使用 "),e("code",[t._v("pnpm exec")]),t._v(" 调用 CLI 时，受本地 Node.js 版本与 pnpm 版本约束影响，命令失败并导致钩子逻辑被跳过。")])]),t._v(" "),e("h2",{attrs:{id:"根因分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#根因分析"}},[t._v("#")]),t._v(" 根因分析")]),t._v(" "),e("ol",[e("li",[t._v("scan 子命令\n"),e("ul",[e("li",[e("code",[t._v("scan")]),t._v(" 用于全量项目反馈，虽然内部有错误统计，但默认不显式 "),e("code",[t._v("process.exit(1)")]),t._v("，因此 pre-commit 钩子不会因错误而失败。")])])]),t._v(" "),e("li",[t._v("commit-file-scan 子命令\n"),e("ul",[e("li",[t._v("专为 pre-commit 设计，基于“已暂存文件（staged files）”扫描。")]),t._v(" "),e("li",[t._v("若存在错误，或在 "),e("code",[t._v("--strict")]),t._v(" 启用时出现警告，会设置非零退出码，阻止提交。")])])]),t._v(" "),e("li",[t._v("Husky 执行环境与脚本\n"),e("ul",[e("li",[t._v("Husky 的 "),e("code",[t._v("_ /husky.sh")]),t._v(" 以 "),e("code",[t._v("sh")]),t._v(" 运行，错误调用或不当模拟可能出现 126（不能执行二进制文件）。")])])]),t._v(" "),e("li",[t._v("pnpm/Node 版本不兼容\n"),e("ul",[e("li",[t._v("本机 Node 较旧（如 v14），与当前 pnpm/依赖的 Node 要求（≥ v18）不一致，"),e("code",[t._v("pnpm exec")]),t._v(" 调用失败，导致钩子被绕过。")])])])]),t._v(" "),e("h2",{attrs:{id:"解决方案与变更"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决方案与变更"}},[t._v("#")]),t._v(" 解决方案与变更")]),t._v(" "),e("ol",[e("li",[t._v("将 pre-commit 调用改为 "),e("code",[t._v("npx --no-install")]),t._v(" "),e("ul",[e("li",[t._v("避免受本地 pnpm/Node 不兼容影响。")]),t._v(" "),e("li",[t._v("采用："),e("code",[t._v("npx --no-install bootstet-fe-lint commit-file-scan --strict")]),t._v("。")])])]),t._v(" "),e("li",[t._v("修正 "),e("code",[t._v(".husky/pre-commit")]),t._v(" 脚本格式\n"),e("ul",[e("li",[t._v("保持 shebang 在首行："),e("code",[t._v("#!/bin/sh")]),t._v("。")]),t._v(" "),e("li",[e("code",[t._v("husky.sh")]),t._v(" 初始化后再 "),e("code",[t._v("set -e")]),t._v("，确保出错即中断。")])])]),t._v(" "),e("li",[t._v("monorepo 依赖指向本地包\n"),e("ul",[e("li",[t._v("将根包的 "),e("code",[t._v("bootstet-fe-lint")]),t._v(" 依赖改为 "),e("code",[t._v("link:./packages/bootstet-fe-lint")]),t._v("（已完成）。")]),t._v(" "),e("li",[t._v("或使用 workspace 协议："),e("code",[t._v("workspace:*")]),t._v("（需工作区开启）。")])])])]),t._v(" "),e("h2",{attrs:{id:"目前行为"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#目前行为"}},[t._v("#")]),t._v(" 目前行为")]),t._v(" "),e("ul",[e("li",[t._v("pre-commit 钩子在有“已暂存文件”的情况下运行 "),e("code",[t._v("commit-file-scan")]),t._v("：\n"),e("ul",[e("li",[t._v("有错误（或 strict 下有警告）时：返回非零退出码，阻止提交。")]),t._v(" "),e("li",[t._v("无问题时：输出通过提示，允许提交。")])])]),t._v(" "),e("li",[t._v("commit-msg 钩子继续使用 commitlint，若提交信息不符合规范仍会阻止提交。")])]),t._v(" "),e("h2",{attrs:{id:"使用与测试步骤"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用与测试步骤"}},[t._v("#")]),t._v(" 使用与测试步骤")]),t._v(" "),e("ol",[e("li",[t._v("制造一个 ESLint 错误（如未使用的变量）。")]),t._v(" "),e("li",[t._v("暂存该文件："),e("code",[t._v("git add <file>")]),t._v("。")]),t._v(" "),e("li",[t._v("尝试提交："),e("code",[t._v('git commit -m "feat: test pre-commit"')]),t._v("。")]),t._v(" "),e("li",[t._v("预期：pre-commit 阻止提交并提示错误位置；修复后重新暂存再提交即可通过。")])]),t._v(" "),e("blockquote",[e("p",[t._v("注意：commit-file-scan 只检查已暂存（staged）的文件，未暂存的更改不会被扫描。")])]),t._v(" "),e("h2",{attrs:{id:"strict-模式说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#strict-模式说明"}},[t._v("#")]),t._v(" strict 模式说明")]),t._v(" "),e("ul",[e("li",[e("code",[t._v("--strict")]),t._v(" 开启后：警告也会导致非零退出码，阻止提交。")]),t._v(" "),e("li",[t._v("若希望仅阻止错误，不阻止警告，可移除 "),e("code",[t._v("--strict")]),t._v("。")])]),t._v(" "),e("h2",{attrs:{id:"workspace-协议简述-与-link-的对比"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#workspace-协议简述-与-link-的对比"}},[t._v("#")]),t._v(" workspace 协议简述（与 link 的对比）")]),t._v(" "),e("ul",[e("li",[t._v("workspace 协议用于在 monorepo 中引用工作区内的本地包。\n"),e("ul",[e("li",[e("code",[t._v("workspace:*")]),t._v("：始终指向本地包，不进行版本校验。")]),t._v(" "),e("li",[e("code",[t._v("workspace:^1.0.0")]),t._v("：要求本地包版本满足约束，不满足则安装失败。")])])]),t._v(" "),e("li",[t._v("与 "),e("code",[t._v("link:")]),t._v(" 的区别：\n"),e("ul",[e("li",[e("code",[t._v("link:")]),t._v(" 直接软链接到路径，不参与版本解析与工作区图谱；link:./packages/bootstet-fe-lint")]),t._v(" "),e("li",[e("code",[t._v("workspace:")]),t._v(" 更适合 monorepo，参与依赖解析与版本一致性校验（更推荐）。")])])])]),t._v(" "),e("h2",{attrs:{id:"常见排查清单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#常见排查清单"}},[t._v("#")]),t._v(" 常见排查清单")]),t._v(" "),e("ul",[e("li",[t._v("Git 钩子路径："),e("code",[t._v("git config core.hooksPath")]),t._v(" 应为 "),e("code",[t._v(".husky")]),t._v("。")]),t._v(" "),e("li",[t._v("文件权限："),e("code",[t._v(".husky/pre-commit")]),t._v(" 需可执行（例如 "),e("code",[t._v("-rwxr-xr-x")]),t._v("）。")]),t._v(" "),e("li",[t._v("Husky 脚本：首行 "),e("code",[t._v("#!/bin/sh")]),t._v("，并正确引入 "),e("code",[t._v("./_ /husky.sh")]),t._v("。")]),t._v(" "),e("li",[t._v("Node 版本：建议 ≥ v18，避免因包管理器/依赖要求导致执行失败。")]),t._v(" "),e("li",[t._v("CLI 可用性：本地包需完成构建（bin 指向的入口文件存在）。")]),t._v(" "),e("li",[t._v("调用方式：优先使用 "),e("code",[t._v("npx --no-install bootstet-fe-lint commit-file-scan")]),t._v("，减少环境差异。")]),t._v(" "),e("li",[t._v("暂存范围：确保需要检查的文件已 "),e("code",[t._v("git add")]),t._v("。")]),t._v(" "),e("li",[t._v("命令选择：\n"),e("ul",[e("li",[t._v("pre-commit："),e("code",[t._v("commit-file-scan")]),t._v("（针对 staged 文件，有退出码）。")]),t._v(" "),e("li",[t._v("项目全量反馈："),e("code",[t._v("scan")]),t._v("（不建议用在 pre-commit，默认不退出）。")])])])]),t._v(" "),e("h2",{attrs:{id:"可选后续优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#可选后续优化"}},[t._v("#")]),t._v(" 可选后续优化")]),t._v(" "),e("ul",[e("li",[t._v("修改 "),e("code",[t._v("scan")]),t._v(" 子命令：在 "),e("code",[t._v("errorCount > 0")]),t._v(" 时显式 "),e("code",[t._v("process.exit(1)")]),t._v("，便于在 CI 中直接失败。")]),t._v(" "),e("li",[t._v("全面采用 workspace 协议，提升依赖一致性与安装语义。")]),t._v(" "),e("li",[t._v("升级 Node 版本，恢复使用 "),e("code",[t._v("pnpm exec")]),t._v(" 调用方式，统一工具链。")]),t._v(" "),e("li",[t._v("在大型仓库启用缓存与并行，降低 pre-commit 执行耗时。")])]),t._v(" "),e("h2",{attrs:{id:"参考的-pre-commit-模板-当前建议"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考的-pre-commit-模板-当前建议"}},[t._v("#")]),t._v(" 参考的 pre-commit 模板（当前建议）")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/sh")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dirname")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$0")]),t._v('"')]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('/_/husky.sh"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v("\n\nnpx --no-install bootstet-fe-lint commit-file-scan "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--strict")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"pre-commit: commit-file-scan passed"')]),t._v("\n")])])]),e("p",[t._v("如需调整 strict 行为或扩展检查范围，可在此基础上增删参数。")])])}),[],!1,null,null,null);e.default=_.exports}}]);